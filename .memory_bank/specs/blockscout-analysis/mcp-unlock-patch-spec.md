# MCP Unlock Patch Script Specification

## 1. Purpose

A utility script that reads the `direct_api_endpoints` section from the `unlock_blockchain_analysis` MCP tool response, identifies endpoints that are not yet documented in the api files generated by `api-file-generator.py`, and inserts those missing endpoints into the appropriate api files and the master index file.

The output of `unlock_blockchain_analysis` includes a curated set of endpoints that agents should use with `direct_api_call`. Some of these endpoints have no swagger source and are therefore absent from the api files produced by `api-file-generator.py`. This script closes that gap.

**The script describes a process driven by the current state of the MCP tool output.** It does not encode a fixed list of endpoints — it always derives what is missing by comparing the live MCP response against the existing documentation. Adding, removing, or reorganising endpoints in `unlock_blockchain_analysis` is handled automatically on the next run; this specification does not need to be updated.

## 2. Relationship to `api-file-generator.py`

`api-file-generator.py` overwrites all api files on every run. This script must therefore run **after** `api-file-generator.py`. If `api-file-generator.py` is re-run, re-run this script afterwards.

The canonical workflow that produces a complete api file set:

```
python .memory_bank/specs/blockscout-analysis/tools/swagger-main-indexer.py
python .memory_bank/specs/blockscout-analysis/tools/swagger-stats-indexer.py
python .memory_bank/specs/blockscout-analysis/tools/api-file-generator.py
python .memory_bank/specs/blockscout-analysis/tools/mcp-unlock-patch.py
```

## 3. Input Sources

| Source | Details |
|--------|---------|
| `unlock_blockchain_analysis` live endpoint | `https://mcp.blockscout.com/v1/unlock_blockchain_analysis` |
| Existing master index | `blockscout-analysis/references/blockscout-api-index.md` |

### 3.1 Response Structure

The script fetches the live endpoint on every run and reads `response["data"]["direct_api_endpoints"]`, which contains two keys:

- `common` — a list of groups, each with a `group` string and an `endpoints` array.
- `specific` — a list of chain entries, each with a `chain_family` string and an `endpoints` array.

Each endpoint object has:

| Field | Type | Notes |
|-------|------|-------|
| `path` | string | Full API path, e.g. `/api/v2/arbitrum/batches/{batch_number}` |
| `description` | string | Human-readable description |

## 4. Output File Layout

The script modifies files that already exist and creates new chain files when needed. All output lives under `blockscout-analysis/references/`.

```
blockscout-analysis/
  references/
    blockscout-api-index.md          # updated with new entries and sections
    blockscout-api/
      transactions.md                # may gain a new ### User Operations section
      <existing chain files>         # may gain new endpoint entries
      <new chain files>              # created for chains not yet in any api file
```

## 5. Identifying Missing Endpoints

### 5.1 Normalised Path Set

Build a set of **normalised paths** from the existing `blockscout-api-index.md`:

1. Read every line of the form `- \`/path\`: ...` or `- /path: ...` (list items in the index).
2. Extract the path (the portion between the backticks or after `- ` up to the first `:`).
3. Normalise: replace every `{param_name}` segment with `{}`.

This set represents all currently documented paths in a parameter-name-agnostic form.

### 5.2 Missing Endpoint Detection

For each endpoint in `direct_api_endpoints` (from both `common` and `specific`):

1. Normalise its `path` using the same substitution rule.
2. If the normalised path is **not** in the normalised set built in 5.1, the endpoint is **missing** and must be added.
3. If the normalised path is already present, skip it silently.

**Rationale for normalisation:** The MCP output uses descriptive parameter names (`{token_contract_address}`, `{batch_number}`) while swagger-generated files use Blockscout's internal parameter names (`{address_hash_param}`, `{batch_number_param}`). Normalising both sides to `{}` handles all such divergences without requiring an explicit mapping.

## 6. Classification of Missing Endpoints

Each missing endpoint is assigned to exactly one output file and one H3 section heading.

### 6.1 Chain-Specific Endpoints (`specific`)

Chain-specific endpoints are always routed by `chain_family`, regardless of path content.

**Auto-derivation rule (default, applies to all `chain_family` values not listed below):**

- Output filename: `chain_family` converted to lowercase with spaces and underscores replaced by hyphens, plus `.md`.
  - Example: `"Shibarium"` → `shibarium.md`; `"New Chain Name"` → `new-chain-name.md`
- H3 heading: title-case of `chain_family` with hyphens and underscores replaced by spaces.
  - Example: `"Shibarium"` → `Shibarium`

When a new `chain_family` appears in `unlock_blockchain_analysis` that is not listed in the special-case table below, the auto-derivation rule automatically produces a new output file — no changes to this specification or the script are needed.

**Special-case configuration** (defined once at the top of the script; overrides auto-derivation for `chain_family` values whose human-readable name does not match the filename chosen by `api-file-generator.py`):

| `chain_family` | Filename override | Heading override |
|---|---|---|
| `Ethereum Mainnet and Gnosis` | `ethereum.md` | `Ethereum PoS Chains` |
| `zkEVM` | `polygon-zkevm.md` | `Polygon zkEVM` |
| `zkSync` | `zksync.md` | `ZkSync` |

### 6.2 Common Endpoints (`common`)

Common endpoints are routed by their `group` field using `COMMON_GROUP_MAP`, a configuration dictionary defined at the top of the script.

**`COMMON_GROUP_MAP` default entries:**

| `group` | Output file | H3 section |
|---|---|---|
| `Stats` | `stats.md` | `### Chain Statistics` if path starts with `/api/v2/`; `### Stats Service` if path starts with `/stats-service/` |
| `Transactions` | `transactions.md` | `### Transactions` |
| `User Operations` | `transactions.md` | `### User Operations` |
| `Tokens & NFTs` | `tokens.md` | `### Tokens` |

**Fallback for unknown `group` values:**

If a `group` is not in `COMMON_GROUP_MAP`, classify by path prefix using the same prefix table as `api-file-generator-spec.md` Section 5.2 (longest-prefix-first matching on the path). If no prefix matches, print a warning identifying the endpoint and skip it.

New `group` values that appear in future versions of `unlock_blockchain_analysis` are handled by this fallback without requiring updates to the specification. `COMMON_GROUP_MAP` should be extended only when the fallback produces incorrect results for a known group.

## 7. Endpoint Entry Format

Each missing endpoint is formatted following `api-format-spec.md` using the data available from `unlock_blockchain_analysis` (no swagger file is consulted).

### 7.1 Heading

```
#### GET /full/api/path/{param}
```

All endpoints from `unlock_blockchain_analysis` are `GET`. The path is used exactly as it appears in the MCP response.

### 7.2 Description

The `description` field from the MCP response, written in full without truncation.

### 7.3 Parameters

Only **path parameters** are documented. Query parameters for these endpoints are not available and are therefore omitted.

Extract path parameters from `{param_name}` placeholders in the path. For each:

| Column | Value |
|--------|-------|
| `Name` | The placeholder name, backtick-wrapped |
| `Type` | Inferred from the parameter name (see Section 7.4) |
| `Required` | Always `Yes` (path parameters are always required) |
| `Description` | Empty string |

If the path contains no `{…}` placeholders, write `*None*` in the parameters section.

**Parameter table format:**

```markdown
- **Parameters**

  | Name | Type | Required | Description |
  | ---- | ---- | -------- | ----------- |
  | `param_name` | `string` | Yes |  |
```

### 7.4 Type Inference for Path Parameters

| Condition | Assigned type |
|-----------|--------------|
| Name ends with `_number` or `_count` | `integer` |
| Name is exactly `epoch_number`, `batch_number`, or `instance_id` | `integer` |
| All other names | `string` |

### 7.5 Example Request

Omit entirely. Path-only parameters with scalar types (`string`, `integer`) do not satisfy the condition for including an Example Request section (see `api-file-generator-spec.md` Section 8, which requires a parameter of type `object` or `array`).

### 7.6 Full Entry Example

For path `/api/v2/arbitrum/batches/{batch_number}` with description `"Get information for a specific Arbitrum batch."`:

```markdown
#### GET /api/v2/arbitrum/batches/{batch_number}

Get information for a specific Arbitrum batch.

- **Parameters**

  | Name | Type | Required | Description |
  | ---- | ---- | -------- | ----------- |
  | `batch_number` | `integer` | Yes |  |
```

## 8. Inserting Entries into API Files

### 8.1 Existing Files with an Existing Target Section

1. Read the file.
2. Locate the target H3 section (e.g., `### Arbitrum`).
3. Find all existing `#### GET /path` entries within that section (section ends at the next `##` heading or end of file).
4. Insert the new entry in sort order: alphabetically by path (case-insensitive), then by HTTP method (`DELETE` < `GET` < `PATCH` < `POST` < `PUT`) for entries sharing a path.
5. Write the modified content back to the file.

### 8.2 Existing Files Without the Target Section

Append the new section at the end of the file:

```markdown

### <H3 heading>

<new endpoint entries sorted by path>
```

### 8.3 New Files

Create the file with this structure:

```markdown
## API Endpoints

### <H3 heading>

<new endpoint entries sorted by path>
```

No preamble is added to newly created chain files. The preamble in `ethereum.md` is managed exclusively by `api-file-generator.py` and must not be modified by this script.

## 9. Updating the Index File

The index file `blockscout-analysis/references/blockscout-api-index.md` is updated after all api files have been written.

### 9.1 Inserting into an Existing Section

If a section for the target file already exists in the index:

1. Find the H2 heading for that section.
2. Collect all existing line items (lines starting with `- \``).
3. Add the new line items.
4. Re-sort all line items for that section by path (alphabetical, case-insensitive).
5. Write the modified section back.

**Line item format:**

```
- `/full/api/path/{param}`: Description text.
```

Path only — no HTTP method prefix. Description is the full `description` value from the MCP response.

### 9.2 Adding a New Chain Section

If no section exists for a new chain file, insert a new H2 section in alphabetical position among the chain-specific sections (which follow all fixed topic sections):

```markdown
## [HeadingName](blockscout-api/filename.md)

- `/path/one`: Description.
- `/path/two`: Description.
```

**Display name** for the section heading = the H3 heading assigned to the file (from classification rules in Section 6).

No preamble text is added for new sections. Sections appear after the fixed topic sections (`Blocks`, `Transactions`, `Addresses`, `Tokens`, `Smart Contracts`, `Search`, `Stats`, `Configuration`) and are ordered alphabetically by filename among chain-specific sections.

## 10. Script Interface

- **Script location:** `.memory_bank/specs/blockscout-analysis/tools/mcp-unlock-patch.py`
- **Invocation:** `python .memory_bank/specs/blockscout-analysis/tools/mcp-unlock-patch.py`
- **Arguments:** None. The script is fully automatic.
- **Working directory:** Repository root (all paths in this spec are relative to the repository root).
- **Exit code:** `0` on success, non-zero on failure.

## 11. Idempotency

The script re-derives the full set of missing endpoints from scratch on every run. It does not store or rely on state from previous runs. Running it multiple times on the same inputs produces the same output files without duplicating entries.

The deduplication check (Section 5.2) ensures that entries already present in the index are never re-added.

## 12. Dependencies

| Dependency | Version | Purpose |
|---|---|---|
| Python | ≥ 3.9 | Runtime |
| requests | ≥ 2.20 | HTTP fetch for live MCP endpoint |

Standard library modules used: `json`, `pathlib`, `re`, `sys`.

## 13. Error Handling

| Scenario | Behaviour |
|---|---|
| Network error or non-200 response fetching MCP endpoint | Print error; exit with code 1 |
| `direct_api_endpoints` key absent from MCP response | Print error; exit with code 1 |
| Index file not found | Print error: "Run api-file-generator.py before running this script"; exit with code 1 |
| Unknown `group` not in `COMMON_GROUP_MAP` and no path-prefix match | Print warning with group name and path; skip endpoint |
| Target api file cannot be written | Print error naming the file; exit with code 1 |

## 14. Console Output

The script prints structured progress messages to stdout. Example (counts will vary with MCP output):

```
Loading unlock_blockchain_analysis response (fetched from live endpoint)...
  N common endpoints across M groups, P chain-specific endpoints across Q chain families

Reading existing index: 93 documented paths

Identifying missing endpoints: 35

Classifying...
  transactions.md  (### User Operations):  1 endpoint
  arbitrum.md      (### Arbitrum):          5 endpoints
  celo.md          (### Celo):              5 endpoints
  optimism.md      (### Optimism):          5 endpoints
  polygon-zkevm.md (### Polygon zkEVM):     4 endpoints
  scroll.md        (### Scroll):            4 endpoints
  zksync.md        (### ZkSync):            2 endpoints
  shibarium.md     (### Shibarium):         2 endpoints  [NEW FILE]
  stability.md     (### Stability):         1 endpoint   [NEW FILE]
  redstone.md      (### Redstone):          4 endpoints  [NEW FILE]
  zilliqa.md       (### Zilliqa):           2 endpoints  [NEW FILE]

Patching API files...
  Patched: blockscout-api/transactions.md (added 1 endpoint to ### User Operations)
  Patched: blockscout-api/arbitrum.md (added 5 endpoints to ### Arbitrum)
  Patched: blockscout-api/celo.md (added 5 endpoints to ### Celo)
  Patched: blockscout-api/optimism.md (added 5 endpoints to ### Optimism)
  Patched: blockscout-api/polygon-zkevm.md (added 4 endpoints to ### Polygon zkEVM)
  Patched: blockscout-api/scroll.md (added 4 endpoints to ### Scroll)
  Patched: blockscout-api/zksync.md (added 2 endpoints to ### ZkSync)
  Created: blockscout-api/shibarium.md (2 endpoints)
  Created: blockscout-api/stability.md (1 endpoint)
  Created: blockscout-api/redstone.md (4 endpoints)
  Created: blockscout-api/zilliqa.md (2 endpoints)

Updating blockscout-api-index.md: 93 → 128 endpoints

Done.
```

## 15. Non-Requirements

- **No tests required.** This is a utility script.
- **No CI/CD integration.** Run manually as part of the api file refresh workflow.
- **No support for non-GET endpoints.** All endpoints from `unlock_blockchain_analysis` are GET; no other methods are handled.
- **No query-parameter documentation.** These endpoints have no swagger source; query parameters are unknown and intentionally omitted.
- **No response schema documentation.** Out of scope, consistent with `api-file-generator-spec.md`.
